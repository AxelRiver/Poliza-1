<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <meta name="theme-color" content="#003087">
 <title>Sistema Profesional de Pólizas 2025</title>

 <!-- MANIFEST PWA -->
 <link rel="manifest" href="manifest.json">

 <!-- ICONOS APP (Apple, Windows, etc.) -->
 <link rel="apple-touch-icon" href="icon-192x192.png">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="default">
 <meta name="mobile-web-app-capable" content="yes">

 <!-- Font Awesome -->
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

 <style>
     :root {
         --azul: #003087;
         --dorado: #D4AF37;
         --gris: #f8f9fa;
         --oscuro: #212529;
     }
     * { margin:0; padding:0; box-sizing:border-box; }
     body {
         font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
         background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
         min-height: 100vh;
         padding: 15px;
     }
     .container {
         max-width: 1300px;
         margin: 0 auto;
         background: white;
         border-radius: 20px;
         box-shadow: 0 20px 60px rgba(0,0,0,0.15);
         overflow: hidden;
     }
     .header {
         background: linear-gradient(135deg, var(--azul) 0%, #001f5b 100%);
         color: white;
         padding: 60px 30px 50px;
         text-align: center;
         position: relative;
     }
     .logo {
         font-size: 5em;
         font-weight: 900;
         letter-spacing: 4px;
         margin-bottom: 20px;
         text-shadow: 0 6px 15px rgba(0,0,0,0.5);
         line-height: 1;
     }
     .header h1 {
         font-size: 3.4em;
         margin: 20px 0 15px;
         font-weight: 700;
         line-height: 1.2;
     }
     .header p { 
         font-size: 1.5em; 
         opacity: 0.95; 
         font-weight: 300;
     }

     .content { padding: 40px; }

     .form-section {
         background: white;
         padding: 35px;
         border-radius: 18px;
         margin-bottom: 35px;
         box-shadow: 0 8px 30px rgba(0,0,0,0.1);
         border-left: 7px solid var(--azul);
     }
     .form-section h2 {
         color: var(--azul);
         font-size: 2em;
         margin-bottom: 28px;
         padding-bottom: 14px;
         border-bottom: 5px solid var(--dorado);
         display: flex;
         align-items: center;
         gap: 15px;
     }

     .form-grid {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
         gap: 25px;
     }
     .form-group label {
         font-weight: 600;
         color: #333;
         margin-bottom: 10px;
         display: block;
         font-size: 1.05em;
     }
     .form-group input, .form-group select, .form-group textarea {
         width: 100%;
         padding: 16px 20px;
         border: 2px solid #ddd;
         border-radius: 14px;
         font-size: 1.1em;
         transition: all 0.3s;
     }
     .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
         outline: none;
         border-color: var(--azul);
         box-shadow: 0 0 0 6px rgba(0, 48, 135, 0.2);
     }

     .btn {
         padding: 16px 40px;
         border: none;
         border-radius: 14px;
         font-weight: 600;
         cursor: pointer;
         font-size: 1.2em;
         transition: all 0.4s;
         display: inline-flex;
         align-items: center;
         gap: 12px;
     }
     .btn-primary { 
         background: linear-gradient(135deg, var(--azul), #001f5b); 
         color: white; 
         box-shadow: 0 10px 30px rgba(0,48,135,0.5);
     }
     .btn-primary:hover { 
         transform: translateY(-5px); 
         box-shadow: 0 15px 40px rgba(0,48,135,0.6);
     }
     .btn-add { 
         background: #28a745; 
         color: white; 
         padding: 14px 30px; 
         font-size: 1.1em;
         border-radius: 12px;
     }
     .btn-print {
         background: #17a2b8;
         color: white;
         padding: 12px 20px;
         font-size: 1em;
         border-radius: 12px;
     }
     .btn-print:hover {
         background: #138496;
     }

     .beneficiario-item {
         background: #f0f8ff;
         padding: 25px;
         border-radius: 14px;
         margin-bottom: 20px;
         border-left: 5px solid var(--dorado);
         position: relative;
     }
     .btn-remove {
         position: absolute;
         top: 12px;
         right: 12px;
         background: #dc3545;
         color: white;
         border: none;
         width: 38px;
         height: 38px;
         border-radius: 50%;
         cursor: pointer;
         font-size: 1.4em;
         font-weight: bold;
     }
     .btn-remove:hover { background: #c82333; }

     .poliza-item {
         background: white;
         border: 2px solid #eee;
         border-radius: 18px;
         padding: 30px;
         margin-bottom: 30px;
         box-shadow: 0 10px 35px rgba(0,0,0,0.1);
         transition: all 0.4s;
     }
     .poliza-item:hover {
         transform: translateY(-10px);
         box-shadow: 0 20px 50px rgba(0,0,0,0.18);
     }
     .poliza-header {
         background: linear-gradient(135deg, var(--azul), #001f5b);
         color: white;
         padding: 20px 30px;
         border-radius: 14px 14px 0 0;
         margin: -30px -30px 30px -30px;
         display: flex;
         justify-content: space-between;
         align-items: center;
         font-size: 1.2em;
     }
     .poliza-numero { 
         font-size: 2em; 
         font-weight: bold; 
     }

     .no-polizas {
         text-align: center;
         padding: 60px;
         color: #666;
         font-size: 1.3em;
     }
 </style>
</head>
<body>

<div class="container">
 <div class="header">
     <div class="logo">SEGUROS</div>
     <h1>SISTEMA PROFESIONAL<br>DE PÓLIZAS 2025</h1>
     <p>Gestión Corporativa • Certificado ISO 9001 • Tecnología Cloud</p>
 </div>

 <div class="content">
     <form id="polizaForm">
         <!-- Todo el formulario exactamente igual que tenías -->
         <div class="form-section">
             <h2><i class="fas fa-user"></i> Datos del Asegurado</h2>
             <div class="form-grid">
                 <div class="form-group"><label>Nombre Completo</label><input type="text" id="nombreCliente" required></div>
                 <div class="form-group"><label>RFC</label><input type="text" id="rfc" required></div>
                 <div class="form-group"><label>Teléfono</label><input type="tel" id="telefono" required></div>
                 <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
                 <div class="form-group full-width"><label>Domicilio Completo</label><input type="text" id="direccion" required></div>
             </div>
         </div>

         <div class="form-section">
             <h2><i class="fas fa-file-contract"></i> Datos de la Póliza</h2>
             <div class="form-grid">
                 <div class="form-group"><label>Tipo de Seguro</label>
                     <select id="tipoSeguro" required>
                         <option value="auto">Automóvil</option>
                         <option value="gastos">Gastos Médicos Mayores</option>
                         <option value="vida">Seguro de Vida</option>
                         <option value="hogar">Hogar</option>
                         <option value="empresa">Empresarial</option>
                     </select>
                 </div>
                 <div class="form-group"><label>N° Póliza</label><input type="text" id="numeroPoliza" readonly style="font-weight:bold;color:var(--azul);font-size:1.2em;"></div>
                 <div class="form-group"><label>Fecha de Emisión</label><input type="date" id="fechaEmision" required></div>
                 <div class="form-group"><label>Forma de Pago</label>
                     <select id="formaPago" required>
                         <option value="anual">Anual</option>
                         <option value="semestral">Semestral</option>
                         <option value="trimestral">Trimestral</option>
                         <option value="mensual">Mensual</option>
                     </select>
                 </div>
                 <div class="form-group"><label>Prima Neta</label><input type="number" step="0.01" id="primaNeta" required></div>
                 <div class="form-group"><label>IVA (16%)</label><input type="text" id="iva" readonly></div>
                 <div class="form-group"><label>Prima Total</label><input type="text" id="primaTotal" readonly style="font-weight:bold;font-size:1.4em;color:green;"></div>
             </div>
         </div>

         <div class="form-section">
             <h2><i class="fas fa-users"></i> Beneficiarios</h2>
             <div id="beneficiariosContainer"></div>
             <button type="button" class="btn btn-add" onclick="agregarBeneficiario()">
                 <i class="fas fa-plus"></i> Agregar Beneficiario
             </button>
         </div>

         <div style="text-align:center;margin:60px 0;">
             <button type="submit" class="btn btn-primary">
                 <i class="fas fa-file-alt"></i> EMITIR PÓLIZA OFICIAL
             </button>
         </div>
     </form>

     <div class="form-section">
         <h2><i class="fas fa-history"></i> Pólizas Emitidas Recientemente</h2>
         <div id="polizasContainer">
             <div class="no-polizas">Cargando pólizas desde la nube...</div>
         </div>
     </div>
 </div>
</div>

<script type="module">
 // REGISTRO DEL SERVICE WORKER
 if ('serviceWorker' in navigator) {
   window.addEventListener('load', () => {
     navigator.serviceWorker.register('/service-worker.js')
       .then(reg => console.log('Service Worker registrado', reg))
       .catch(err => console.log('Error al registrar SW', err));
   });
 }

 import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
 import { getDatabase, ref, push, onValue } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

 const app = initializeApp({ 
     databaseURL: 'https://polizas-a5513-default-rtdb.firebaseio.com/' 
 });
 const db = getDatabase(app);
 const polizasRef = ref(db, 'polizas_profesional');

 let polizas = [];
 let ultimoNumero = 100000;

 document.getElementById('fechaEmision').valueAsDate = new Date();

 function generarNumeroPoliza() {
     const año = new Date().getFullYear();
     ultimoNumero++;
     return `POL-${año}-${String(ultimoNumero).padStart(6, '0')}`;
 }

 document.getElementById('primaNeta').addEventListener('input', function() {
     const neta = parseFloat(this.value) || 0;
     const iva = neta * 0.16;
     const total = neta + iva;
     document.getElementById('iva').value = iva.toFixed(2);
     document.getElementById('primaTotal').value = total.toFixed(2);
 });

 window.agregarBeneficiario = function() {
     const container = document.getElementById('beneficiariosContainer');
     const index = container.children.length + 1;
     
     const div = document.createElement('div');
     div.className = 'beneficiario-item';
     div.innerHTML = `
         <button type="button" class="btn-remove" onclick="this.parentElement.remove()">×</button>
         <div class="form-grid">
             <div class="form-group">
                 <label>Nombre Completo del Beneficiario ${index}</label>
                 <input type="text" class="benef-nombre" required>
             </div>
             <div class="form-group">
                 <label>Parentesco</label>
                 <input type="text" class="benef-parentesco" required>
             </div>
             <div class="form-group">
                 <label>Porcentaje</label>
                 <input type="number" class="benef-porcentaje" value="100" min="1" max="100" required>
             </div>
         </div>
     `;
     container.appendChild(div);
 };

 window.imprimirPoliza = function(poliza) {
     // ... (tu función imprimirPoliza sin cambios)
     // (la copié tal cual arriba, la mantengo igual)
     const printWindow = window.open('', '', 'width=900,height=800');
     const fecha = new Date(poliza.fechaEmision).toLocaleDateString('es-MX', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
     
     let beneficiariosHTML = '';
     poliza.beneficiarios.forEach(b => {
         beneficiariosHTML += `
             <tr>
                 <td style="padding:10px;border:1px solid #ddd;">${b.nombre}</td>
                 <td style="padding:10px;border:1px solid #ddd;">${b.parentesco}</td>
                 <td style="padding:10px;border:1px solid #ddd;text-align:center;">${b.porcentaje}%</td>
             </tr>`;
     });

     printWindow.document.write(`
     <!DOCTYPE html>
     <html lang="es">
     <head>
         <meta charset="UTF-8">
         <title>Póliza ${poliza.numeroPoliza}</title>
         <style>
             body {font-family: Arial, sans-serif; margin:40px; line-height:1.6;}
             .header {text-align:center; margin-bottom:40px;}
             .logo {font-size:4em; font-weight:900; color:#003087;}
             h1 {color:#003087;}
             table {width:100%; border-collapse:collapse; margin:25px 0;}
             th {background:#003087; color:white; padding:12px;}
             td {border:1px solid #ddd; padding:10px;}
             .footer {margin-top:60px; text-align:center; font-size:0.9em; color:#555;}
             @media print { body {margin:20px;} }
         </style>
     </head>
     <body>
         <div class="header">
             <div class="logo">SEGUROS</div>
             <h1>PÓLIZA OFICIAL</h1>
             <h2>N° ${poliza.numeroPoliza}</h2>
             <p>Fecha de emisión: ${fecha}</p>
         </div>

         <h2>Datos del Asegurado</h2>
         <p><strong>Nombre:</strong> ${poliza.nombreCliente}<br>
            <strong>RFC:</strong> ${poliza.rfc}<br>
            <strong>Teléfono:</strong> ${poliza.telefono}<br>
            <strong>Email:</strong> ${poliza.email}<br>
            <strong>Domicilio:</strong> ${poliza.direccion}</p>

         <h2>Datos de la Póliza</h2>
         <p><strong>Tipo de seguro:</strong> ${poliza.tipoSeguro.toUpperCase()}<br>
            <strong>Forma de pago:</strong> ${poliza.formaPago}<br>
            <strong>Prima neta:</strong> $${parseFloat(poliza.primaNeta).toLocaleString('es-MX')}<br>
            <strong>IVA:</strong> $${parseFloat(poliza.iva).toLocaleString('es-MX')}<br>
            <strong>Prima total:</strong> <strong style="font-size:1.4em;color:green;">$${parseFloat(poliza.primaTotal).toLocaleString('es-MX')}</strong></p>

         <h2>Beneficiarios</h2>
         <table>
             <thead><tr><th>Nombre</th><th>Parentesco</th><th>Porcentaje</th></tr></thead>
             <tbody>${beneficiariosHTML}</tbody>
         </table>

         <div class="footer">
             <p>Sistema Profesional de Pólizas 2025 • Certificado ISO 9001 • Tecnología Cloud</p>
             <p>Esta es una póliza oficial emitida electrónicamente.</p>
         </div>
     </body>
     </html>
     `);
     printWindow.document.close();
     printWindow.focus();
     setTimeout(() => {
         printWindow.print();
         printWindow.close();
     }, 500);
 };

 function mostrarPolizas() {
     const container = document.getElementById('polizasContainer');
     
     if (polizas.length === 0) {
         container.innerHTML = '<div class="no-polizas">No hay pólizas emitidas aún</div>';
         return;
     }

     const ordenadas = polizas.sort((a,b) => b.fechaEmision.localeCompare(a.fechaEmision));

     container.innerHTML = ordenadas.map(p => `
         <div class="poliza-item">
             <div class="poliza-header">
                 <div class="poliza-numero">${p.numeroPoliza}</div>
                 <div>${new Date(p.fechaEmision).toLocaleDateString('es-MX', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</div>
             </div>
             <h3 style="margin:15px 0;color:var(--azul);font-size:1.6em;">${p.nombreCliente}</h3>
             <p><strong>Tipo:</strong> ${p.tipoSeguro.toUpperCase()} • <strong>Prima Total:</strong> <span style="color:green;font-size:1.3em;font-weight:bold;">$${parseFloat(p.primaTotal).toLocaleString('es-MX')}</span></p>
             <p><strong>Forma de pago:</strong> ${p.formaPago} • <strong>Beneficiarios:</strong> ${p.beneficiarios.length}</p>
             <div style="text-align:right; margin-top:20px;">
                 <button class="btn btn-print" onclick="imprimirPoliza(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                     <i class="fas fa-print"></i> Imprimir Póliza
                 </button>
             </div>
         </div>
     `).join('');
 }

 onValue(polizasRef, (snapshot) => {
     const data = snapshot.val();
     if (data) {
         polizas = Object.entries(data).map(([id, val]) => ({id, ...val}));
         const numeros = polizas.map(p => {
             const match = p.numeroPoliza?.match(/(\d{6})$/);
             return match ? parseInt(match[0]) : 0;
         });
         ultimoNumero = numeros.length > 0 ? Math.max(...numeros) : 100000;
     } else {
         polizas = [];
         ultimoNumero = 100000;
     }

     document.getElementById('numeroPoliza').value = generarNumeroPoliza();
     mostrarPolizas();
 });

 document.getElementById('polizaForm').onsubmit = async (e) => {
     e.preventDefault();

     const beneficiarios = Array.from(document.querySelectorAll('.beneficiario-item')).map(item => ({
         nombre: item.querySelector('.benef-nombre').value.trim(),
         parentesco: item.querySelector('.benef-parentesco').value.trim(),
         porcentaje: item.querySelector('.benef-porcentaje').value
     })).filter(b => b.nombre);

     const poliza = {
         numeroPoliza: document.getElementById('numeroPoliza').value,
         fechaEmision: document.getElementById('fechaEmision').value,
         nombreCliente: document.getElementById('nombreCliente').value.trim(),
         rfc: document.getElementById('rfc').value.trim(),
         telefono: document.getElementById('telefono').value.trim(),
         email: document.getElementById('email').value.trim(),
         direccion: document.getElementById('direccion').value.trim(),
         tipoSeguro: document.getElementById('tipoSeguro').value,
         primaNeta: parseFloat(document.getElementById('primaNeta').value),
         iva: parseFloat(document.getElementById('iva').value),
         primaTotal: parseFloat(document.getElementById('primaTotal').value),
         formaPago: document.getElementById('formaPago').value,
         beneficiarios
     };

     try {
         await push(polizasRef, poliza);
         document.getElementById('numeroPoliza').value = generarNumeroPoliza();
         e.target.reset();
         document.getElementById('beneficiariosContainer').innerHTML = '';
         agregarBeneficiario();
         alert('PÓLIZA EMITIDA Y GUARDADA EN LA NUBE');
     } catch (err) {
         alert('Error: ' + err.message);
     }
 };

 // Iniciar con un beneficiario
 agregarBeneficiario();
</script>
</body>
</html>
